<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Survival Timer - nid Project</title>
    
    <!-- PWA é…ç½® -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="ç”Ÿå­˜å€’è®¡æ—¶">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/3563/3563411.png">
    
    <!-- åŠ¨æ€ç”Ÿæˆ Manifest -->
    <link id="manifest-link" rel="manifest">

    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root { --bg-dark: #0f172a; --bg-light: #f1f5f9; --text-dark: #f8fafc; --text-light: #1e293b; }
        
        /* å¸ƒå±€ä¿®å¤ï¼šé”å®šè§†å£é«˜åº¦ */
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden; 
        }

        body { 
            background-color: var(--bg-dark); 
            color: var(--text-dark); 
            transition: background-color 0.3s ease, color 0.3s ease; 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; 
            display: flex; 
            flex-direction: column; 
            width: 100vw;
            padding-top: env(safe-area-inset-top);
            padding-bottom: env(safe-area-inset-bottom);
            -webkit-tap-highlight-color: transparent; 
        }
        
        body.light-mode { background-color: var(--bg-light); color: var(--text-light); }
        
        /* åœ†ç¯è¿›åº¦æ¡ */
        .ring-inner { fill: none; stroke-width: 12; stroke-linecap: round; transition: stroke-dashoffset 0.8s cubic-bezier(0.4, 0, 0.2, 1), stroke 0.5s; transform: rotate(-90deg); transform-origin: center; }
        .ring-outer { fill: none; stroke-width: 8; stroke-linecap: round; transition: stroke-dashoffset 0.4s cubic-bezier(0.4, 0, 0.2, 1); transform: rotate(-90deg); transform-origin: center; }
        .ring-bg { fill: none; stroke: #334155; stroke-width: 12; opacity: 0.2; }
        body.light-mode .ring-bg { stroke: #cbd5e1; opacity: 0.5; }

        /* ç±»å‹é€‰æ‹©å™¨ */
        .picker-container { display: flex; overflow-x: auto; scroll-snap-type: x mandatory; scrollbar-width: none; padding: 0 calc(50% - 40px); mask-image: linear-gradient(to right, transparent, black 40%, black 60%, transparent); -webkit-overflow-scrolling: touch; }
        .picker-container::-webkit-scrollbar { display: none; }
        .picker-item { flex: 0 0 80px; scroll-snap-align: center; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: all 0.3s; opacity: 0.3; transform: scale(0.8); }
        .picker-item.active { opacity: 1; transform: scale(1.1); }

        /* ä»»åŠ¡åˆ—è¡¨æ»šåŠ¨åŒº */
        #pendingContainer {
            flex: 1; 
            overflow-y: auto; 
            -webkit-overflow-scrolling: touch; 
            padding: 0.5rem 1rem 1.5rem 1rem;
        }

        .tap-scale:active { transform: scale(0.95); }
        .btn-inbox { background: linear-gradient(135deg, #6366f1, #4f46e5); }
        .btn-start { background: linear-gradient(135deg, #f59e0b, #d97706); }
        .btn-finish { background: linear-gradient(135deg, #10b981, #059669); }
        
        .pending-item { animation: slide-in 0.3s ease-out; position: relative; margin-bottom: 0.75rem; }
        @keyframes slide-in { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .task-timer-bar { position: absolute; bottom: 0; left: 0; height: 3px; background: #ef4444; opacity: 0.4; transition: width 1s linear; border-radius: 0 0 1rem 1rem; }
    </style>
</head>
<body>

    <!-- ç¦»çº¿å°±ç»ªæç¤º -->
    <div id="offlineReady" class="hidden fixed top-4 left-1/2 -translate-x-1/2 z-[110] bg-green-500 text-white px-4 py-2 rounded-full text-[10px] font-bold shadow-2xl animate-bounce">
        å·²å°±ç»ªï¼šæ”¯æŒæ–­ç½‘æ‰“å¼€
    </div>

    <header class="flex justify-between items-center px-6 py-2 shrink-0">
        <button onclick="toggleTheme()" class="w-9 h-9 flex items-center justify-center bg-slate-800/50 rounded-full shadow-lg tap-scale text-sm">
            <span id="themeIcon">ğŸŒ™</span>
        </button>
        <div class="flex gap-2">
            <button onclick="undo()" class="px-3 py-1.5 bg-slate-800/50 rounded-full text-[10px] font-black text-orange-500 shadow-lg tap-scale">â†© UNDO</button>
            <button onclick="toggleHistory(true)" class="px-3 py-1.5 bg-slate-800/50 rounded-full text-[10px] font-black shadow-lg tap-scale">ğŸ“œ LOG</button>
        </div>
    </header>

    <main class="flex flex-col items-center justify-center py-1 shrink-0">
        <div class="relative w-48 h-48">
            <svg width="192" height="192" viewBox="0 0 320 320">
                <circle class="ring-bg" cx="160" cy="160" r="120" />
                <circle id="innerCircle" class="ring-inner" cx="160" cy="160" r="120" stroke-dasharray="753.98" stroke-dashoffset="0" stroke="#22c55e" />
                <circle class="ring-bg" cx="160" cy="160" r="140" style="stroke-width:2;" />
                <circle id="outerCircle" class="ring-outer" cx="160" cy="160" r="140" stroke-dasharray="879.64" stroke-dashoffset="0" stroke="#3b82f6" />
            </svg>
            <div class="absolute inset-0 flex flex-col items-center justify-center pointer-events-none">
                <div id="timeDisplay" class="text-2xl font-mono font-black tracking-tighter mb-0.5">00:00:00</div>
                <div class="text-[7px] opacity-40 tracking-[0.2em] uppercase font-bold">Life Remaining</div>
            </div>
        </div>
    </main>

    <div class="px-6 py-2 flex flex-col gap-2 shrink-0">
        <input id="actionNote" type="text" placeholder="Task memo..." 
               class="w-full bg-slate-500/10 border border-slate-500/20 rounded-xl px-4 py-2 text-sm text-center outline-none focus:ring-2 focus:ring-blue-500">
        
        <div id="typePicker" class="picker-container h-14"></div>
        
        <div class="flex gap-2">
            <button onclick="submitAction('inbox')" class="flex-1 py-3 btn-inbox text-white font-black rounded-xl tap-scale flex flex-col items-center justify-center">
                <span class="text-xs tracking-wider">INBOX</span>
            </button>
            <button onclick="submitAction('start_now')" class="flex-1 py-3 btn-start text-white font-black rounded-xl tap-scale flex flex-col items-center justify-center">
                <span class="text-xs tracking-wider">START</span>
            </button>
            <button onclick="submitAction('finish_direct')" class="flex-[1.2] py-3 btn-finish text-white font-black rounded-xl tap-scale flex flex-col items-center justify-center relative">
                <span class="text-xs tracking-wider">DONE</span>
                <div id="injectValue" class="absolute right-1.5 top-1.5 text-[8px] bg-white/20 px-1 rounded-full">+0.5h</div>
            </button>
        </div>
    </div>

    <!-- ä»»åŠ¡åˆ—è¡¨æ»šåŠ¨åŒº -->
    <div id="pendingContainer"></div>

    <!-- å†å²è®°å½•æŠ½å±‰ -->
    <div id="historyDrawer" class="fixed inset-0 z-50 transform translate-y-full transition-transform duration-300 flex flex-col">
        <div class="flex-grow bg-black/20" onclick="toggleHistory(false)"></div>
        <div class="bg-slate-900 rounded-t-[2rem] p-6 h-[70vh] flex flex-col">
            <div class="w-12 h-1 bg-white/10 rounded-full mx-auto mb-6"></div>
            <div id="historyList" class="overflow-y-auto space-y-2 flex-grow"></div>
        </div>
    </div>

    <div id="deathOverlay" class="hidden fixed inset-0 z-[100] flex flex-col items-center justify-center bg-black">
        <div class="text-red-600 text-5xl font-black mb-12 animate-pulse text-center">YOU ARE<br>TERMINATED</div>
        <button onclick="reborn()" class="px-12 py-4 bg-red-600 text-white font-black rounded-full">RE-INITIALIZE</button>
    </div>

    <script>
        // --- ç¦»çº¿æ”¯æŒå…³é”®ï¼šService Worker è‡ªåŠ¨ç”Ÿæˆä¸æ³¨å†Œ ---
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                // ç”Ÿæˆä¸€ä¸ªå†…è”è„šæœ¬ï¼Œé¿å…å¤–éƒ¨æ–‡ä»¶ç¼ºå¤±
                const swCode = `
                    const CACHE_NAME = 'survival-v1';
                    const urlsToCache = [location.href, 'https://cdn.tailwindcss.com'];
                    
                    self.addEventListener('install', (event) => {
                        event.waitUntil(caches.open(CACHE_NAME).then((cache) => cache.addAll(urlsToCache)));
                    });

                    self.addEventListener('fetch', (event) => {
                        event.respondWith(
                            caches.match(event.request).then((response) => response || fetch(event.request))
                        );
                    });
                `;
                const blob = new Blob([swCode], { type: 'text/javascript' });
                const swUrl = URL.createObjectURL(blob);
                
                navigator.serviceWorker.register(swUrl).then(() => {
                    console.log('SW Registered');
                    // ä»…é¦–æ¬¡æé†’ä¸€æ¬¡
                    if(!localStorage.getItem('sw_notified')) {
                        document.getElementById('offlineReady').classList.remove('hidden');
                        setTimeout(() => {
                            document.getElementById('offlineReady').classList.add('hidden');
                            localStorage.setItem('sw_notified', 'true');
                        }, 3000);
                    }
                });
            });
        }

        // åŠ¨æ€ç”Ÿæˆ Manifestï¼Œè§£å†³æ²¡æœ‰ manifest.json æ–‡ä»¶çš„é—®é¢˜
        const manifest = {
            "name": "ç”Ÿå­˜å€’è®¡æ—¶",
            "short_name": "ç”Ÿå­˜",
            "start_url": ".",
            "display": "standalone",
            "background_color": "#0f172a",
            "theme_color": "#0f172a",
            "icons": [{ "src": "https://cdn-icons-png.flaticon.com/512/3563/3563411.png", "sizes": "512x512", "type": "image/png" }]
        };
        const stringManifest = JSON.stringify(manifest);
        const blob = new Blob([stringManifest], {type: 'application/json'});
        const manifestURL = URL.createObjectURL(blob);
        document.querySelector('#manifest-link').setAttribute('href', manifestURL);

        // --- æ ¸å¿ƒé…ç½® ---
        const TASK_LIFESPAN = 48 * 3600; 
        const PUNISHMENT = 3 * 3600; 
        const MAX_SINGLE_AWARD = 8; 
        const PROGRESS_CYCLE = 48 * 3600;

        const CONFIG = [
            { id: 'core', name: 'æ ¸å¿ƒ', emoji: 'ğŸ¯', type: 'multiplier', factor: 2.0 },
            { id: 'input', name: 'è¾“å…¥', emoji: 'ğŸ“š', type: 'multiplier', factor: 1.2 },
            { id: 'self_care', name: 'ä¿®èº«', emoji: 'ğŸŒ±', type: 'fixed', value: 1.5 },
            { id: 'admin', name: 'æ‚é¡¹', emoji: 'ğŸ“', type: 'fixed', value: 0.4 },
            { id: 'spark', name: 'çµæ„Ÿ', emoji: 'âš¡', type: 'fixed', value: 0.1 }
        ];

        // --- æŒä¹…åŒ–é€»è¾‘ ---
        const storedTime = localStorage.getItem('st_timeLeft');
        const storedUpdateAt = localStorage.getItem('st_lastUpdateAt');
        
        let state = {
            timeLeft: (storedTime !== null && !isNaN(parseFloat(storedTime))) ? parseFloat(storedTime) : 48 * 3600,
            history: JSON.parse(localStorage.getItem('st_history')) || [],
            pending: JSON.parse(localStorage.getItem('st_pending')) || [],
            isDark: true,
            selectedIndex: 0,
            lastTick: Date.now()
        };

        // ç¦»çº¿è¡¥å¿
        if (storedUpdateAt) {
            const now = Date.now();
            const elapsedSinceLastSave = (now - parseInt(storedUpdateAt)) / 1000;
            if (elapsedSinceLastSave > 0) {
                state.timeLeft = Math.max(0, state.timeLeft - elapsedSinceLastSave);
            }
        }

        function save() {
            try {
                localStorage.setItem('st_timeLeft', state.timeLeft.toString());
                localStorage.setItem('st_lastUpdateAt', Date.now().toString());
                localStorage.setItem('st_history', JSON.stringify(state.history.slice(0, 100)));
                localStorage.setItem('st_pending', JSON.stringify(state.pending));
            } catch (e) {}
        }

        // iOS æŒä¹…åŒ–ç›‘å¬
        window.addEventListener('pagehide', save);
        window.addEventListener('beforeunload', save);
        document.addEventListener('visibilitychange', () => {
            if (document.visibilityState === 'hidden') {
                save();
            } else {
                const now = Date.now();
                const gap = (now - state.lastTick) / 1000;
                if (gap > 2) state.timeLeft = Math.max(0, state.timeLeft - gap);
                state.lastTick = now;
                render();
            }
        });

        // --- UI & äº¤äº’é€»è¾‘ ---

        function initPicker() {
            const picker = document.getElementById('typePicker');
            picker.innerHTML = CONFIG.map((item, index) => `
                <div class="picker-item ${index === 0 ? 'active' : ''}" onclick="scrollToItem(${index})">
                    <span class="text-2xl mb-0.5">${item.emoji}</span>
                    <span class="text-[9px] font-black opacity-60">${item.name}</span>
                </div>
            `).join('');
            
            picker.onscroll = () => {
                const center = picker.scrollLeft + picker.offsetWidth / 2;
                const items = picker.querySelectorAll('.picker-item');
                let activeIdx = 0; let minDiff = Infinity;
                items.forEach((item, idx) => {
                    const diff = Math.abs(center - (item.offsetLeft + item.offsetWidth / 2));
                    if (diff < minDiff) { minDiff = diff; activeIdx = idx; }
                });
                if (state.selectedIndex !== activeIdx) {
                    state.selectedIndex = activeIdx;
                    updatePickerVisuals();
                }
            };
        }

        function scrollToItem(index) {
            const picker = document.getElementById('typePicker');
            const item = picker.children[index];
            picker.scrollTo({ left: item.offsetLeft - (picker.offsetWidth / 2) + (item.offsetWidth / 2), behavior: 'smooth' });
        }

        function updatePickerVisuals() {
            const items = document.querySelectorAll('.picker-item');
            items.forEach((item, idx) => item.classList.toggle('active', idx === state.selectedIndex));
            const config = CONFIG[state.selectedIndex];
            document.getElementById('injectValue').innerText = config.type === 'multiplier' ? `${config.factor}x` : `+${config.value}h`;
        }

        function submitAction(type) {
            const config = CONFIG[state.selectedIndex];
            const note = document.getElementById('actionNote').value.trim() || 'Untitled Task';
            const now = Date.now();
            if (type === 'finish_direct') {
                const awardHours = Math.min(config.type === 'fixed' ? config.value : 0, MAX_SINGLE_AWARD);
                state.timeLeft += awardHours * 3600;
                addHistory(config, note, awardHours, "Done");
            } else {
                state.pending.unshift({
                    id: now, createdAt: now, note, emoji: config.emoji, 
                    type: config.name, configId: config.id, status: type === 'start_now' ? 'running' : 'idle',
                    startedAt: type === 'start_now' ? now : null, accumulatedTime: 0
                });
            }
            document.getElementById('actionNote').value = '';
            save(); render(); renderPending(true);
        }

        function addHistory(config, note, hours, statusLabel) {
            const now = new Date();
            state.history.unshift({
                id: Date.now(), emoji: config.emoji, type: config.name, note,
                add: hours, addLabel: hours.toFixed(1) + 'h', statusLabel,
                timestamp: now.getHours() + ":" + String(now.getMinutes()).padStart(2,'0')
            });
        }

        function finalizeTask(id) {
            const task = state.pending.find(t => t.id === id);
            const config = CONFIG.find(c => c.id === task.configId);
            let totalSec = task.accumulatedTime || 0;
            if (task.status === 'running') totalSec += (Date.now() - task.startedAt) / 1000;
            const awardHours = Math.min(config.type === 'multiplier' ? (totalSec/3600)*config.factor : config.value, MAX_SINGLE_AWARD);
            state.timeLeft += awardHours * 3600;
            addHistory(config, task.note, awardHours, "Done");
            state.pending = state.pending.filter(p => p.id !== id);
            save(); render(); renderPending(true);
        }

        function toggleTask(id) {
            const task = state.pending.find(t => t.id === id);
            if (!task) return;
            if (task.status === 'running') {
                task.accumulatedTime += (Date.now() - task.startedAt) / 1000;
                task.status = 'idle'; task.startedAt = null;
            } else {
                task.status = 'running'; task.startedAt = Date.now();
            }
            save(); renderPending(true);
        }

        function renderPending(force = false) {
            const container = document.getElementById('pendingContainer');
            if (force) {
                container.innerHTML = state.pending.map(t => `
                    <div class="pending-item bg-white/5 p-4 rounded-2xl flex items-center justify-between border border-white/5 shadow-lg">
                        <div class="task-timer-bar" id="bar-${t.id}"></div>
                        <div class="flex items-center gap-3 overflow-hidden">
                            <span class="text-2xl">${t.emoji}</span>
                            <div class="flex flex-col truncate">
                                <span class="text-[9px] font-black opacity-40 uppercase tracking-tighter">${t.type}</span>
                                <span class="text-sm font-bold truncate">â€œ${t.note}â€</span>
                            </div>
                        </div>
                        <div class="flex items-center gap-2 relative z-10">
                            <button onclick="toggleTask(${t.id})" class="px-3 py-1.5 rounded-lg text-[10px] font-black ${t.status === 'running' ? 'bg-red-500/20 text-red-400' : 'bg-amber-500/20 text-amber-400'} border border-current">
                                ${t.status === 'running' ? 'STOP' : 'START'}
                            </button>
                            <button onclick="finalizeTask(${t.id})" class="px-3 py-1.5 bg-green-500/20 text-green-400 rounded-lg text-[10px] font-black border border-current">DONE</button>
                        </div>
                    </div>
                `).join('');
            }
            
            const now = Date.now();
            state.pending.forEach(t => {
                const bar = document.getElementById(`bar-${t.id}`);
                if (bar) {
                    const elapsed = (now - t.createdAt) / 1000;
                    const percent = Math.max(0, 100 - (elapsed / TASK_LIFESPAN) * 100);
                    bar.style.width = percent + '%';
                    
                    if (percent <= 0) {
                        state.timeLeft -= PUNISHMENT;
                        state.history.unshift({
                            id: Date.now(), emoji: 'âš ï¸', type: 'SYSTEM', note: `è¶…æ—¶: ${t.note}`,
                            add: -PUNISHMENT/3600, addLabel: `-${PUNISHMENT/3600}h`, statusLabel: "Expired",
                            timestamp: new Date().getHours() + ":" + String(new Date().getMinutes()).padStart(2,'0')
                        });
                        state.pending = state.pending.filter(p => p.id !== t.id);
                        save(); render(); renderPending(true);
                    }
                }
            });
        }

        function tick() {
            if (state.timeLeft > 0) {
                state.timeLeft -= 1;
                state.lastTick = Date.now();
                render(); 
                renderPending();
                if (Math.floor(state.timeLeft) % 5 === 0) save();
            } else handleDeath();
        }

        function render() {
            const h = Math.floor(state.timeLeft / 3600);
            const m = Math.floor((state.timeLeft % 3600) / 60);
            const s = Math.floor(state.timeLeft % 60);
            document.getElementById('timeDisplay').innerText = `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
            document.getElementById('innerCircle').style.strokeDashoffset = 753.98 * (1 - (state.timeLeft % PROGRESS_CYCLE) / PROGRESS_CYCLE);
            document.getElementById('outerCircle').style.strokeDashoffset = 879.64 * (1 - (state.timeLeft % (6*3600)) / (6*3600));
        }

        function toggleTheme() {
            state.isDark = !state.isDark;
            document.body.classList.toggle('light-mode', !state.isDark);
            document.getElementById('themeIcon').innerText = state.isDark ? 'ğŸŒ™' : 'â˜€ï¸';
        }

        function toggleHistory(show) {
            const drawer = document.getElementById('historyDrawer');
            if (show) {
                document.getElementById('historyList').innerHTML = state.history.map(h => `
                    <div class="flex items-center justify-between p-3 bg-white/5 rounded-xl text-xs">
                        <div class="flex items-center gap-2"><span>${h.emoji}</span><span class="font-bold">${h.note}</span></div>
                        <div class="flex items-center gap-2 font-mono"><span class="${h.add >=0 ? 'text-green-400' : 'text-red-400'}">${h.addLabel}</span><span class="opacity-30 ml-2">${h.timestamp}</span></div>
                    </div>
                `).join('');
                drawer.style.transform = 'translateY(0)';
            } else {
                drawer.style.transform = 'translateY(100%)';
            }
        }

        function undo() {
            if (state.history.length === 0) return;
            const last = state.history.shift();
            state.timeLeft = Math.max(0, state.timeLeft - (last.add * 3600));
            save(); render();
        }

        function reborn() { 
            state.timeLeft = 48*3600; 
            state.pending = []; 
            localStorage.clear();
            save(); 
            location.reload(); 
        }

        function handleDeath() { 
            document.getElementById('deathOverlay').classList.remove('hidden'); 
        }

        initPicker(); 
        render(); 
        renderPending(true); 
        setInterval(tick, 1000);
    </script>
</body>
</html>
