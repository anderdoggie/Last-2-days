<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Survival Timer - nid Project</title>
    
    <!-- PWA é…ç½® -->
    <link rel="manifest" href="manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="ç”Ÿå­˜å€’è®¡æ—¶">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/3563/3563411.png">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root { --bg-dark: #0f172a; --bg-light: #f1f5f9; --text-dark: #f8fafc; --text-light: #1e293b; }
        
        /* å¸ƒå±€ä¿®å¤ï¼šé”å®šè§†å£é«˜åº¦ï¼Œé˜²æ­¢æ•´ä½“æ©¡çš®ç­‹æ•ˆæœ */
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden; 
        }

        body { 
            background-color: var(--bg-dark); 
            color: var(--text-dark); 
            transition: background-color 0.3s ease, color 0.3s ease; 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; 
            display: flex; 
            flex-direction: column; 
            width: 100vw;
            /* é€‚é… iOS å®‰å…¨åŒºåŸŸ */
            padding-top: env(safe-area-inset-top);
            padding-bottom: env(safe-area-inset-bottom);
            -webkit-tap-highlight-color: transparent; 
        }
        
        body.light-mode { background-color: var(--bg-light); color: var(--text-light); }
        
        /* åœ†ç¯è¿›åº¦æ¡ */
        .ring-inner { fill: none; stroke-width: 12; stroke-linecap: round; transition: stroke-dashoffset 0.8s cubic-bezier(0.4, 0, 0.2, 1), stroke 0.5s; transform: rotate(-90deg); transform-origin: center; }
        .ring-outer { fill: none; stroke-width: 8; stroke-linecap: round; transition: stroke-dashoffset 0.4s cubic-bezier(0.4, 0, 0.2, 1); transform: rotate(-90deg); transform-origin: center; }
        .ring-bg { fill: none; stroke: #334155; stroke-width: 12; opacity: 0.2; }
        body.light-mode .ring-bg { stroke: #cbd5e1; opacity: 0.5; }

        /* ç±»å‹é€‰æ‹©å™¨ */
        .picker-container { display: flex; overflow-x: auto; scroll-snap-type: x mandatory; scrollbar-width: none; padding: 0 calc(50% - 40px); mask-image: linear-gradient(to right, transparent, black 40%, black 60%, transparent); -webkit-overflow-scrolling: touch; }
        .picker-container::-webkit-scrollbar { display: none; }
        .picker-item { flex: 0 0 80px; scroll-snap-align: center; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: all 0.3s; opacity: 0.3; transform: scale(0.8); }
        .picker-item.active { opacity: 1; transform: scale(1.1); }

        /* ä»»åŠ¡åˆ—è¡¨æ ¸å¿ƒä¿®å¤ï¼šå¼€å¯ç‹¬ç«‹æ»šåŠ¨åŒºåŸŸ */
        #pendingContainer {
            flex: 1; 
            overflow-y: auto; 
            -webkit-overflow-scrolling: touch; 
            padding: 0 1rem 1.5rem 1rem;
        }

        .tap-scale:active { transform: scale(0.95); }
        .btn-inbox { background: linear-gradient(135deg, #6366f1, #4f46e5); }
        .btn-start { background: linear-gradient(135deg, #f59e0b, #d97706); }
        .btn-finish { background: linear-gradient(135deg, #10b981, #059669); }
        
        .pending-item { animation: slide-in 0.3s ease-out; position: relative; margin-bottom: 0.75rem; }
        @keyframes slide-in { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .task-timer-bar { position: absolute; bottom: 0; left: 0; height: 3px; background: #ef4444; opacity: 0.4; transition: width 1s linear; border-radius: 0 0 1rem 1rem; }
    </style>
</head>
<body>

    <header class="flex justify-between items-center px-6 py-4 shrink-0">
        <button onclick="toggleTheme()" class="w-10 h-10 flex items-center justify-center bg-slate-800/50 rounded-full shadow-lg tap-scale">
            <span id="themeIcon">ğŸŒ™</span>
        </button>
        <div class="flex gap-2">
            <button onclick="undo()" class="px-4 py-2 bg-slate-800/50 rounded-full text-[11px] font-black text-orange-500 shadow-lg tap-scale">â†© æ’¤é”€</button>
            <button onclick="toggleHistory(true)" class="px-4 py-2 bg-slate-800/50 rounded-full text-[11px] font-black shadow-lg tap-scale">ğŸ“œ è®°å½•</button>
        </div>
    </header>

    <main class="flex flex-col items-center justify-center py-2 shrink-0">
        <div class="relative w-56 h-56">
            <svg width="224" height="224" viewBox="0 0 320 320">
                <circle class="ring-bg" cx="160" cy="160" r="120" />
                <circle id="innerCircle" class="ring-inner" cx="160" cy="160" r="120" stroke-dasharray="753.98" stroke-dashoffset="0" stroke="#22c55e" />
                <circle class="ring-bg" cx="160" cy="160" r="140" style="stroke-width:2;" />
                <circle id="outerCircle" class="ring-outer" cx="160" cy="160" r="140" stroke-dasharray="879.64" stroke-dashoffset="0" stroke="#3b82f6" />
            </svg>
            <div class="absolute inset-0 flex flex-col items-center justify-center pointer-events-none">
                <div id="timeDisplay" class="text-3xl font-mono font-black tracking-tighter mb-1">00:00:00</div>
                <div class="text-[8px] opacity-40 tracking-[0.2em] uppercase font-bold">Life Remaining</div>
            </div>
        </div>
    </main>

    <div class="px-6 py-4 flex flex-col gap-4 shrink-0">
        <input id="actionNote" type="text" placeholder="è¾“å…¥ä»»åŠ¡å¤‡æ³¨..." 
               class="w-full bg-slate-500/10 border border-slate-500/20 rounded-2xl px-5 py-3 text-base text-center outline-none focus:ring-2 focus:ring-blue-500">
        <div id="typePicker" class="picker-container h-16"></div>
        <div class="flex gap-3">
            <button onclick="submitAction('inbox')" class="flex-1 py-4 btn-inbox text-white font-black rounded-2xl tap-scale flex flex-col items-center">
                <span class="text-[9px] opacity-70 uppercase">Inbox</span><span>æ”¶çº³</span>
            </button>
            <button onclick="submitAction('start_now')" class="flex-1 py-4 btn-start text-white font-black rounded-2xl tap-scale flex flex-col items-center">
                <span class="text-[9px] opacity-70 uppercase">Start</span><span>å¼€å§‹</span>
            </button>
            <button onclick="submitAction('finish_direct')" class="flex-[1.2] py-4 btn-finish text-white font-black rounded-2xl tap-scale flex flex-col items-center relative">
                <span class="text-[9px] opacity-70 uppercase">Finish</span><span>å®Œæˆ</span>
                <div id="injectValue" class="absolute right-2 top-2 text-[9px] bg-white/20 px-1 rounded-full">+0.5h</div>
            </button>
        </div>
    </div>

    <!-- ä»»åŠ¡åˆ—è¡¨æ»šåŠ¨åŒº -->
    <div id="pendingContainer"></div>

    <!-- å†å²è®°å½•æŠ½å±‰ -->
    <div id="historyDrawer" class="fixed inset-0 z-50 transform translate-y-full transition-transform duration-300 flex flex-col">
        <div class="flex-grow bg-black/20" onclick="toggleHistory(false)"></div>
        <div class="bg-slate-900 rounded-t-[2.5rem] p-6 h-[75vh] flex flex-col">
            <div class="w-12 h-1 bg-white/10 rounded-full mx-auto mb-6"></div>
            <div id="historyList" class="overflow-y-auto space-y-2 flex-grow"></div>
        </div>
    </div>

    <div id="deathOverlay" class="hidden fixed inset-0 z-[100] flex flex-col items-center justify-center bg-black">
        <div class="text-red-600 text-5xl font-black mb-12 animate-pulse text-center">YOU ARE<br>TERMINATED</div>
        <button onclick="reborn()" class="px-12 py-4 bg-red-600 text-white font-black rounded-full">RE-INITIALIZE</button>
    </div>

    <script>
        // æ³¨å†Œ Service Worker
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js').then(reg => {
                    reg.onupdatefound = () => {
                        const installingWorker = reg.installing;
                        installingWorker.onstatechange = () => {
                            if (installingWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                window.location.reload(); 
                            }
                        };
                    };
                });
            });
        }

        const TASK_LIFESPAN = 48 * 3600; const PUNISHMENT = 3 * 3600; const MAX_SINGLE_AWARD = 8; const PROGRESS_CYCLE = 48 * 3600;
        const CONFIG = [
            { id: 'core', name: 'æ ¸å¿ƒ', emoji: 'ğŸ¯', type: 'multiplier', factor: 2.0 },
            { id: 'input', name: 'è¾“å…¥', emoji: 'ğŸ“š', type: 'multiplier', factor: 1.2 },
            { id: 'self_care', name: 'ä¿®èº«', emoji: 'ğŸŒ±', type: 'fixed', value: 1.5 },
            { id: 'admin', name: 'æ‚é¡¹', emoji: 'ğŸ“', type: 'fixed', value: 0.4 },
            { id: 'spark', name: 'çµæ„Ÿ', emoji: 'âš¡', type: 'fixed', value: 0.1 }
        ];

        let state = {
            timeLeft: parseFloat(localStorage.getItem('st_timeLeft')) || 48 * 3600,
            history: JSON.parse(localStorage.getItem('st_history')) || [],
            pending: JSON.parse(localStorage.getItem('st_pending')) || [],
            isDark: true,
            selectedIndex: 0
        };

        function save() {
            localStorage.setItem('st_timeLeft', state.timeLeft);
            localStorage.setItem('st_history', JSON.stringify(state.history.slice(0, 100)));
            localStorage.setItem('st_pending', JSON.stringify(state.pending));
        }

        function initPicker() {
            const picker = document.getElementById('typePicker');
            picker.innerHTML = CONFIG.map((item, index) => `
                <div class="picker-item ${index === 0 ? 'active' : ''}" onclick="scrollToItem(${index})">
                    <span class="text-3xl mb-1">${item.emoji}</span>
                    <span class="text-[10px] font-black opacity-60">${item.name}</span>
                </div>
            `).join('');
            
            picker.onscroll = () => {
                const center = picker.scrollLeft + picker.offsetWidth / 2;
                const items = picker.querySelectorAll('.picker-item');
                let activeIdx = 0; let minDiff = Infinity;
                items.forEach((item, idx) => {
                    const diff = Math.abs(center - (item.offsetLeft + item.offsetWidth / 2));
                    if (diff < minDiff) { minDiff = diff; activeIdx = idx; }
                });
                if (state.selectedIndex !== activeIdx) {
                    state.selectedIndex = activeIdx;
                    updatePickerVisuals();
                }
            };
        }

        function scrollToItem(index) {
            const picker = document.getElementById('typePicker');
            const item = picker.children[index];
            picker.scrollTo({ left: item.offsetLeft - (picker.offsetWidth / 2) + (item.offsetWidth / 2), behavior: 'smooth' });
        }

        function updatePickerVisuals() {
            const items = document.querySelectorAll('.picker-item');
            items.forEach((item, idx) => item.classList.toggle('active', idx === state.selectedIndex));
            const config = CONFIG[state.selectedIndex];
            document.getElementById('injectValue').innerText = config.type === 'multiplier' ? `${config.factor}x` : `+${config.value}h`;
        }

        function submitAction(type) {
            const config = CONFIG[state.selectedIndex];
            const note = document.getElementById('actionNote').value.trim() || 'æœªå‘½åä»»åŠ¡';
            const now = Date.now();
            if (type === 'finish_direct') {
                const awardHours = Math.min(config.type === 'fixed' ? config.value : 0, MAX_SINGLE_AWARD);
                state.timeLeft += awardHours * 3600;
                addHistory(config, note, awardHours, "ç›´æ¥å®Œæˆ");
            } else {
                state.pending.unshift({
                    id: now, createdAt: now, note, emoji: config.emoji, 
                    type: config.name, configId: config.id, status: type === 'start_now' ? 'running' : 'idle',
                    startedAt: type === 'start_now' ? now : null, accumulatedTime: 0
                });
            }
            document.getElementById('actionNote').value = '';
            save(); render(); renderPending(true);
        }

        function addHistory(config, note, hours, statusLabel) {
            const now = new Date();
            state.history.unshift({
                id: Date.now(), emoji: config.emoji, type: config.name, note,
                add: hours, addLabel: hours.toFixed(1) + 'h', statusLabel,
                timestamp: now.getHours() + ":" + String(now.getMinutes()).padStart(2,'0')
            });
        }

        function finalizeTask(id) {
            const task = state.pending.find(t => t.id === id);
            const config = CONFIG.find(c => c.id === task.configId);
            let totalSec = task.accumulatedTime || 0;
            if (task.status === 'running') totalSec += (Date.now() - task.startedAt) / 1000;
            const awardHours = Math.min(config.type === 'multiplier' ? (totalSec/3600)*config.factor : config.value, MAX_SINGLE_AWARD);
            state.timeLeft += awardHours * 3600;
            addHistory(config, task.note, awardHours, "ä»»åŠ¡å®Œæˆ");
            state.pending = state.pending.filter(p => p.id !== id);
            save(); render(); renderPending(true);
        }

        function toggleTask(id) {
            const task = state.pending.find(t => t.id === id);
            if (!task) return;
            if (task.status === 'running') {
                task.accumulatedTime += (Date.now() - task.startedAt) / 1000;
                task.status = 'idle'; task.startedAt = null;
            } else {
                task.status = 'running'; task.startedAt = Date.now();
            }
            save(); renderPending(true);
        }

        function renderPending(force = false) {
            const container = document.getElementById('pendingContainer');
            if (force) {
                container.innerHTML = state.pending.map(t => `
                    <div class="pending-item bg-white/5 p-4 rounded-2xl flex items-center justify-between border border-white/5 shadow-lg">
                        <div class="task-timer-bar" id="bar-${t.id}"></div>
                        <div class="flex items-center gap-3 overflow-hidden">
                            <span class="text-2xl">${t.emoji}</span>
                            <div class="flex flex-col truncate">
                                <span class="text-[9px] font-black opacity-40 uppercase tracking-tighter">${t.type}</span>
                                <span class="text-sm font-bold truncate">â€œ${t.note}â€</span>
                            </div>
                        </div>
                        <div class="flex items-center gap-2 relative z-10">
                            <button onclick="toggleTask(${t.id})" class="px-3 py-1.5 rounded-lg text-[10px] font-black ${t.status === 'running' ? 'bg-red-500/20 text-red-400' : 'bg-amber-500/20 text-amber-400'} border border-current">
                                ${t.status === 'running' ? 'STOP' : 'START'}
                            </button>
                            <button onclick="finalizeTask(${t.id})" class="px-3 py-1.5 bg-green-500/20 text-green-400 rounded-lg text-[10px] font-black border border-current">DONE</button>
                        </div>
                    </div>
                `).join('');
            }
            
            const now = Date.now();
            state.pending.forEach(t => {
                const bar = document.getElementById(`bar-${t.id}`);
                if (bar) {
                    const elapsed = (now - t.createdAt) / 1000;
                    const percent = Math.max(0, 100 - (elapsed / TASK_LIFESPAN) * 100);
                    bar.style.width = percent + '%';
                    if (percent <= 0) {
                        state.timeLeft -= PUNISHMENT;
                        state.pending = state.pending.filter(p => p.id !== t.id);
                        save(); render(); renderPending(true);
                    }
                }
            });
        }

        function tick() {
            if (state.timeLeft > 0) {
                state.timeLeft -= 1;
                render(); renderPending();
                if (Math.floor(state.timeLeft) % 30 === 0) save();
            } else handleDeath();
        }

        function render() {
            const h = Math.floor(state.timeLeft / 3600);
            const m = Math.floor((state.timeLeft % 3600) / 60);
            const s = Math.floor(state.timeLeft % 60);
            document.getElementById('timeDisplay').innerText = `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
            document.getElementById('innerCircle').style.strokeDashoffset = 753.98 * (1 - (state.timeLeft % PROGRESS_CYCLE) / PROGRESS_CYCLE);
            document.getElementById('outerCircle').style.strokeDashoffset = 879.64 * (1 - (state.timeLeft % (6*3600)) / (6*3600));
        }

        function toggleTheme() {
            state.isDark = !state.isDark;
            document.body.classList.toggle('light-mode', !state.isDark);
            document.getElementById('themeIcon').innerText = state.isDark ? 'ğŸŒ™' : 'â˜€ï¸';
        }

        function toggleHistory(show) {
            const drawer = document.getElementById('historyDrawer');
            if (show) {
                document.getElementById('historyList').innerHTML = state.history.map(h => `
                    <div class="flex items-center justify-between p-3 bg-white/5 rounded-xl text-xs">
                        <div class="flex items-center gap-2"><span>${h.emoji}</span><span class="font-bold">${h.note}</span></div>
                        <div class="flex items-center gap-2 font-mono"><span class="${h.add >=0 ? 'text-green-400' : 'text-red-400'}">${h.addLabel}</span><span class="opacity-30 ml-2">${h.timestamp}</span></div>
                    </div>
                `).join('');
                drawer.style.transform = 'translateY(0)';
            } else {
                drawer.style.transform = 'translateY(100%)';
            }
        }

        function undo() {
            if (state.history.length === 0) return;
            const last = state.history.shift();
            state.timeLeft = Math.max(0, state.timeLeft - (last.add * 3600));
            save(); render();
        }

        function reborn() { state.timeLeft = 48*3600; state.pending = []; save(); location.reload(); }
        function handleDeath() { document.getElementById('deathOverlay').classList.remove('hidden'); }

        initPicker(); render(); renderPending(true); setInterval(tick, 1000);
    </script>
</body>
</html>
