<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Survival Timer - nid Project</title>
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="ÁîüÂ≠òÂÄíËÆ°Êó∂">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/3563/3563411.png">
    <link id="manifest-link" rel="manifest">

    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root { --bg-dark: #020617; --bg-light: #f8fafc; --accent: #3b82f6; }
        html, body { height: 100%; margin: 0; padding: 0; overflow: hidden; background-color: var(--bg-dark); }
        body { color: #f8fafc; transition: background-color 0.4s ease; font-family: system-ui, -apple-system, sans-serif; display: flex; flex-direction: column; width: 100vw; padding-top: env(safe-area-inset-top); padding-bottom: env(safe-area-inset-bottom); -webkit-tap-highlight-color: transparent; }
        body.light-mode { background-color: var(--bg-light); color: #1e293b; }
        .ring-inner { fill: none; stroke-width: 10; stroke-linecap: round; transition: stroke-dashoffset 0.3s ease; transform: rotate(-90deg); transform-origin: center; }
        .ring-outer { fill: none; stroke-width: 6; stroke-linecap: round; transition: stroke-dashoffset 0.3s ease; transform: rotate(-90deg); transform-origin: center; }
        .ring-bg { fill: none; stroke: #1e293b; stroke-width: 10; opacity: 0.2; }
        body.light-mode .ring-bg { stroke: #cbd5e1; opacity: 0.5; }
        .picker-container { display: flex; overflow-x: auto; scroll-snap-type: x mandatory; scrollbar-width: none; padding: 0 calc(50% - 40px); mask-image: linear-gradient(to right, transparent, black 40%, black 60%, transparent); -webkit-overflow-scrolling: touch; }
        .picker-container::-webkit-scrollbar { display: none; }
        .picker-item { flex: 0 0 80px; scroll-snap-align: center; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: all 0.3s; opacity: 0.2; transform: scale(0.8); }
        .picker-item.active { opacity: 1; transform: scale(1.1); }
        #pendingContainer { flex: 1; overflow-y: auto; padding: 1rem; }
        .tap-scale:active { transform: scale(0.96); }
        .glass { background: rgba(255, 255, 255, 0.03); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.05); }
        body.light-mode .glass { background: rgba(0, 0, 0, 0.03); border: 1px solid rgba(0, 0, 0, 0.05); }
        .btn-gradient-blue { background: linear-gradient(135deg, #3b82f6, #2563eb); }
        .btn-gradient-amber { background: linear-gradient(135deg, #f59e0b, #d97706); }
        .btn-gradient-emerald { background: linear-gradient(135deg, #10b981, #059669); }
        .task-timer-bar { position: absolute; bottom: 0; left: 0; height: 3px; background: #ef4444; opacity: 0.6; border-radius: 0 0 1rem 1rem; }
    </style>
</head>
<body>

    <header class="flex justify-between items-center px-6 py-4 shrink-0">
        <button onclick="toggleTheme()" class="w-10 h-10 flex items-center justify-center glass rounded-2xl tap-scale">
            <span id="themeIcon">üåô</span>
        </button>
        <div class="flex gap-2">
            <button onclick="undo()" class="px-4 py-2 glass rounded-xl text-[10px] font-bold text-orange-400 tap-scale">UNDO</button>
            <button onclick="toggleHistory(true)" class="px-4 py-2 glass rounded-xl text-[10px] font-bold tap-scale">HISTORY</button>
        </div>
    </header>

    <main class="flex flex-col items-center justify-center py-4 shrink-0">
        <div class="relative w-56 h-56">
            <svg width="224" height="224" viewBox="0 0 320 320">
                <circle class="ring-bg" cx="160" cy="160" r="120" />
                <circle id="innerCircle" class="ring-inner" cx="160" cy="160" r="120" stroke-dasharray="753.98" stroke-dashoffset="0" stroke="#10b981" />
                <circle class="ring-bg" cx="160" cy="160" r="140" style="stroke-width:2;" />
                <circle id="outerCircle" class="ring-outer" cx="160" cy="160" r="140" stroke-dasharray="879.64" stroke-dashoffset="0" stroke="#3b82f6" />
            </svg>
            <div class="absolute inset-0 flex flex-col items-center justify-center pointer-events-none">
                <div id="timeDisplay" class="text-3xl font-mono font-bold tracking-tight">00:00:00</div>
                <div class="text-[8px] opacity-40 tracking-[0.3em] uppercase mt-1">Life Remaining</div>
            </div>
        </div>
    </main>

    <div class="px-6 py-4 flex flex-col gap-4 shrink-0">
        <input id="actionNote" type="text" placeholder="What are you doing?" class="w-full glass rounded-2xl px-5 py-3 text-sm text-center outline-none focus:ring-2 focus:ring-blue-500/50 transition-all">
        <div id="typePicker" class="picker-container h-16"></div>
        <div class="flex gap-3">
            <button onclick="submitAction('inbox')" class="flex-1 py-4 btn-gradient-blue text-white font-bold rounded-2xl tap-scale">
                <span class="text-[10px] tracking-widest">INBOX</span>
            </button>
            <button onclick="submitAction('start_now')" class="flex-1 py-4 btn-gradient-amber text-white font-bold rounded-2xl tap-scale">
                <span class="text-[10px] tracking-widest">START</span>
            </button>
            <button onclick="submitAction('finish_direct')" class="flex-[1.2] py-4 btn-gradient-emerald text-white font-bold rounded-2xl tap-scale relative">
                <span class="text-[10px] tracking-widest">DONE</span>
                <div id="injectValue" class="absolute right-2 top-2 text-[8px] bg-white/20 px-1.5 py-0.5 rounded-full">+0.5h</div>
            </button>
        </div>
    </div>

    <div id="pendingContainer"></div>

    <div id="historyDrawer" class="fixed inset-0 z-50 transform translate-y-full transition-transform duration-500 flex flex-col">
        <div class="flex-grow" onclick="toggleHistory(false)"></div>
        <div class="bg-slate-950/95 backdrop-blur-xl rounded-t-[2.5rem] p-8 h-[75vh] flex flex-col border-t border-white/5">
            <div class="w-12 h-1.5 bg-white/10 rounded-full mx-auto mb-8"></div>
            <div id="historyList" class="overflow-y-auto space-y-3 flex-grow pb-10"></div>
        </div>
    </div>

    <div id="deathOverlay" class="hidden fixed inset-0 z-[100] flex flex-col items-center justify-center bg-slate-950 px-10">
        <div class="text-red-500 text-6xl font-black mb-4 animate-pulse">TERMINATED</div>
        <button onclick="reborn()" class="w-full max-w-xs py-4 bg-white text-black font-black rounded-2xl tap-scale">RE-INITIALIZE</button>
    </div>

    <script>
        const TASK_LIFESPAN = 48 * 3600; 
        const PUNISHMENT = 3 * 3600; 
        const PROGRESS_CYCLE = 48 * 3600;

        const CONFIG = [
            { id: 'core', name: 'CORE', emoji: 'üéØ', type: 'multiplier', factor: 2.0 },
            { id: 'input', name: 'INPUT', emoji: 'üìö', type: 'multiplier', factor: 1.2 },
            { id: 'self_care', name: 'WELLNESS', emoji: 'üå±', type: 'fixed', value: 1.5 },
            { id: 'admin', name: 'MISC', emoji: 'üìé', type: 'fixed', value: 0.4 },
            { id: 'spark', name: 'SPARK', emoji: '‚ö°', type: 'fixed', value: 0.1 }
        ];

        // --- ‰øÆÂ§çÂêéÂè∞ÊöÇÂÅúÁöÑÂÖ≥ÈîÆÈÄªËæë ---
        // Êàë‰ª¨ËÆ∞ÂΩï targetEndTime (ÁõÆÊ†áÁªìÊùüÊó∂Èó¥ÁöÑÊó∂Èó¥Êà≥)
        let state = {
            targetEndTime: parseInt(localStorage.getItem('st_targetEndTime')) || (Date.now() + 48 * 3600 * 1000),
            history: JSON.parse(localStorage.getItem('st_history')) || [],
            pending: JSON.parse(localStorage.getItem('st_pending')) || [],
            isDark: true,
            selectedIndex: 0
        };

        function getSecondsLeft() {
            return Math.max(0, (state.targetEndTime - Date.now()) / 1000);
        }

        function updateTargetTime(secondsToAdd) {
            state.targetEndTime += (secondsToAdd * 1000);
            save();
        }

        function save() {
            localStorage.setItem('st_targetEndTime', state.targetEndTime.toString());
            localStorage.setItem('st_history', JSON.stringify(state.history.slice(0, 50)));
            localStorage.setItem('st_pending', JSON.stringify(state.pending));
        }

        function tick() {
            const timeLeft = getSecondsLeft();
            if (timeLeft <= 0) {
                handleDeath();
            } else {
                render(timeLeft);
                renderPending(timeLeft);
            }
        }

        function render(timeLeft) {
            const h = Math.floor(timeLeft / 3600);
            const m = Math.floor((timeLeft % 3600) / 60);
            const s = Math.floor(timeLeft % 60);
            document.getElementById('timeDisplay').innerText = `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
            document.getElementById('innerCircle').style.strokeDashoffset = 753.98 * (1 - (timeLeft % PROGRESS_CYCLE) / PROGRESS_CYCLE);
            document.getElementById('outerCircle').style.strokeDashoffset = 879.64 * (1 - (timeLeft % (6*3600)) / (6*3600));
        }

        function submitAction(type) {
            const config = CONFIG[state.selectedIndex];
            const noteInput = document.getElementById('actionNote');
            const note = noteInput.value.trim() || 'Untitled';
            
            if (type === 'finish_direct') {
                const hours = config.type === 'fixed' ? config.value : 0;
                updateTargetTime(hours * 3600);
                addHistory(config, note, hours, "Instant");
            } else {
                state.pending.unshift({
                    id: Date.now(), createdAt: Date.now(), note, emoji: config.emoji, 
                    type: config.name, configId: config.id, status: type === 'start_now' ? 'running' : 'idle',
                    startedAt: type === 'start_now' ? Date.now() : null, accumulatedTime: 0
                });
            }
            noteInput.value = '';
            save(); renderPending(getSecondsLeft(), true);
        }

        function finalizeTask(id) {
            const idx = state.pending.findIndex(t => t.id === id);
            const task = state.pending[idx];
            const config = CONFIG.find(c => c.id === task.configId);
            let totalSec = task.accumulatedTime + (task.status === 'running' ? (Date.now() - task.startedAt)/1000 : 0);
            
            const hours = config.type === 'multiplier' ? (totalSec/3600)*config.factor : config.value;
            updateTargetTime(hours * 3600);
            addHistory(config, task.note, hours, "Done");
            state.pending.splice(idx, 1);
            save(); renderPending(getSecondsLeft(), true);
        }

        function toggleTask(id) {
            const task = state.pending.find(t => t.id === id);
            if (task.status === 'running') {
                task.accumulatedTime += (Date.now() - task.startedAt) / 1000;
                task.status = 'idle'; task.startedAt = null;
            } else {
                task.status = 'running'; task.startedAt = Date.now();
            }
            save(); renderPending(getSecondsLeft(), true);
        }

        function renderPending(timeLeft, force = false) {
            const container = document.getElementById('pendingContainer');
            if (force) {
                container.innerHTML = state.pending.map(t => `
                    <div class="glass p-4 rounded-3xl flex items-center justify-between mb-3 relative overflow-hidden">
                        <div class="task-timer-bar" id="bar-${t.id}"></div>
                        <div class="flex items-center gap-3">
                            <span class="text-2xl">${t.emoji}</span>
                            <div class="flex flex-col truncate">
                                <span class="text-[8px] font-bold opacity-30">${t.type}</span>
                                <span class="text-xs font-semibold">${t.note}</span>
                            </div>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="toggleTask(${t.id})" class="px-3 py-2 rounded-xl text-[9px] font-bold ${t.status === 'running' ? 'bg-red-500/20 text-red-500' : 'bg-amber-500/20 text-amber-500'}">
                                ${t.status === 'running' ? 'STOP' : 'START'}
                            </button>
                            <button onclick="finalizeTask(${t.id})" class="px-3 py-2 bg-emerald-500/20 text-emerald-400 rounded-xl text-[9px] font-bold">DONE</button>
                        </div>
                    </div>
                `).join('');
            }
            
            state.pending.forEach((t, idx) => {
                const bar = document.getElementById(`bar-${t.id}`);
                if (bar) {
                    const elapsed = (Date.now() - t.createdAt) / 1000;
                    const percent = Math.max(0, 100 - (elapsed / TASK_LIFESPAN) * 100);
                    bar.style.width = percent + '%';
                    if (percent <= 0) {
                        updateTargetTime(-PUNISHMENT);
                        addHistory({emoji:'‚ö†Ô∏è', name:'SYSTEM'}, `Penalty: ${t.note}`, -PUNISHMENT/3600, "Expired");
                        state.pending.splice(idx, 1);
                        save(); renderPending(getSecondsLeft(), true);
                    }
                }
            });
        }

        function addHistory(config, note, hours, statusLabel) {
            const now = new Date();
            state.history.unshift({
                id: Date.now(), emoji: config.emoji, type: config.name, note,
                add: hours, addLabel: (hours >= 0 ? '+' : '') + hours.toFixed(1) + 'h',
                timestamp: now.getHours().toString().padStart(2,'0') + ":" + now.getMinutes().toString().padStart(2,'0')
            });
        }

        function undo() {
            if (state.history.length === 0) return;
            const last = state.history.shift();
            updateTargetTime(-last.add * 3600);
            save(); tick();
        }

        function toggleTheme() {
            state.isDark = !state.isDark;
            document.body.classList.toggle('light-mode', !state.isDark);
            document.getElementById('themeIcon').innerText = state.isDark ? 'üåô' : '‚òÄÔ∏è';
        }

        function toggleHistory(show) {
            const drawer = document.getElementById('historyDrawer');
            if (show) {
                document.getElementById('historyList').innerHTML = state.history.map(h => `
                    <div class="flex items-center justify-between p-4 glass rounded-2xl">
                        <div class="flex items-center gap-3">
                            <span class="text-xl">${h.emoji}</span>
                            <div class="flex flex-col">
                                <span class="text-[10px] font-bold text-blue-400">${h.type}</span>
                                <span class="text-xs font-medium">${h.note}</span>
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="text-xs font-mono font-bold ${h.add >= 0 ? 'text-emerald-400' : 'text-red-400'}">${h.addLabel}</div>
                            <div class="text-[8px] opacity-30">${h.timestamp}</div>
                        </div>
                    </div>
                `).join('');
                drawer.style.transform = 'translateY(0)';
            } else drawer.style.transform = 'translateY(100%)';
        }

        function reborn() { localStorage.clear(); location.reload(); }
        function handleDeath() { document.getElementById('deathOverlay').classList.remove('hidden'); }

        // --- ÂàùÂßãÂåñÈÄâÊã©Âô® ---
        const picker = document.getElementById('typePicker');
        picker.innerHTML = CONFIG.map((item, index) => `
            <div class="picker-item ${index === 0 ? 'active' : ''}" onclick="scrollToItem(${index})">
                <span class="text-3xl mb-1">${item.emoji}</span>
                <span class="text-[8px] font-bold opacity-60">${item.name}</span>
            </div>
        `).join('');
        picker.onscroll = () => {
            const center = picker.scrollLeft + picker.offsetWidth / 2;
            let activeIdx = 0; let minDiff = Infinity;
            [...picker.children].forEach((item, idx) => {
                const diff = Math.abs(center - (item.offsetLeft + item.offsetWidth / 2));
                if (diff < minDiff) { minDiff = diff; activeIdx = idx; }
            });
            if (state.selectedIndex !== activeIdx) {
                state.selectedIndex = activeIdx;
                [...document.querySelectorAll('.picker-item')].forEach((it, i) => it.classList.toggle('active', i === activeIdx));
                const c = CONFIG[activeIdx];
                document.getElementById('injectValue').innerText = c.type === 'multiplier' ? `${c.factor}x` : `+${c.value}h`;
            }
        };
        function scrollToItem(idx) {
            const it = picker.children[idx];
            picker.scrollTo({ left: it.offsetLeft - (picker.offsetWidth / 2) + (it.offsetWidth / 2), behavior: 'smooth' });
        }

        // ÂêØÂä®
        setInterval(tick, 1000);
        renderPending(getSecondsLeft(), true);

        // Ê†∏ÂøÉ‰øÆÂ§çÔºöÂΩìÂâçÂè∞ÂèØËßÅÊÄßÊîπÂèòÊó∂Á´ãÂç≥Âà∑Êñ∞
        document.addEventListener('visibilitychange', () => {
            if (!document.hidden) tick();
        });
    </script>
</body>
</html>
